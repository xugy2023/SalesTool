{% extends 'base.html' %}
{% block content %}
<style>
  .chart-title {
    font-weight: 700;
    color: #2e7d32;
  }
  .legend {
    font-size: 0.875rem;
    color: #6c757d;
  }
</style>
<div class="container py-5">
  <h2 class="text-success mb-4">
    <i class="bi bi-bar-chart"></i> é”€å”®æ•°æ®åˆ†æä»ªè¡¨ç›˜
  </h2>

  <div class="row g-4">
    <div class="col-12">
      <div class="card border-0 shadow-sm">
        <div class="card-body">
          <h5 class="chart-title">âœ… é€šè¯è¯„åˆ†åˆ†å¸ƒ</h5>
          <canvas id="scoreChart" height="120"></canvas>
          <div class="legend mt-2">ç»¿è‰²ä»£è¡¨é«˜åˆ†ï¼ˆ80+ï¼‰ï¼Œæ©™è‰²ä¸ºä¸­ç­‰ï¼Œçº¢è‰²ä¸ºåä½</div>
        </div>
      </div>
    </div>

    <div class="col-md-6">
      <div class="card border-0 shadow-sm">
        <div class="card-body">
          <h5 class="chart-title">ğŸ˜Š æƒ…ç»ªå æ¯”</h5>
          <canvas id="emotionChart" height="150"></canvas>
          <div class="legend mt-2">ä»æ‰€æœ‰é€šè¯ä¸­ç»Ÿè®¡æƒ…ç»ªç¬¦å·å‡ºç°é¢‘ç‡</div>
        </div>
      </div>
    </div>

    <div class="col-md-6">
      <div class="card border-0 shadow-sm">
        <div class="card-body">
          <h5 class="chart-title">ğŸ“ˆ æƒ…ç»ªå˜åŒ–è¶‹åŠ¿</h5>
          <canvas id="emotionTrendChart" height="150"></canvas>
          <div class="legend mt-2">è§‚å¯Ÿæ¯æ¬¡é€šè¯ä¸­ç§¯æã€ä¸­æ€§ã€æ¶ˆæçš„å˜åŒ–è¶‹åŠ¿</div>
        </div>
      </div>
    </div>

    <div class="col-12">
      <div class="card border-0 shadow-sm">
        <div class="card-body">
          <h5 class="chart-title">ğŸ”‘ å…³é”®è¯ä½¿ç”¨é¢‘ç‡</h5>
          <canvas id="keywordChart" height="120"></canvas>
          <div class="legend mt-2">å¸®åŠ©åˆ¤æ–­é”€å”®æ˜¯å¦ä½¿ç”¨äº†å…³é”®è¯æœ¯</div>
        </div>
      </div>
    </div>

    <div class="col-12">
      <div class="card border-0 shadow-sm">
        <div class="card-body">
          <h5 class="chart-title">ğŸ‘¤ å®¢æˆ·ç”»åƒé¢„è§ˆ</h5>
          {% for filename in score_data.labels %}
            <div class="border-bottom py-2">
              <div class="d-flex justify-content-between align-items-center">
                <div>
                  ğŸ§¾ <a href="/profile/{{ filename }}" target="_blank">{{ filename }}</a>
                </div>
                <div>
                  {% set status = analysis_results[filename]['status'] if 'status' in analysis_results[filename] else '' %}
                  {% if status == 'æœ‰æ„å‘' %}
                    <span class="badge bg-success">æœ‰æ„å‘</span>
                  {% elif status == 'æ— æ„å‘' %}
                    <span class="badge bg-danger">æ— æ„å‘</span>
                  {% elif status == 'ä¿æŒè”ç³»' %}
                    <span class="badge bg-warning text-dark">ä¿æŒè”ç³»</span>
                  {% endif %}
                </div>
              </div>
              <div class="mt-1 text-muted small">
                ğŸ”¢ å¾—åˆ†ï¼š{{ score_data.values[loop.index0] }}/100
                {% if score_data.reasons and score_data.reasons[loop.index0] %}
                  <br>ğŸ§  è¯„åˆ†ç†ç”±ï¼š{{ score_data.reasons[loop.index0] }}
                {% endif %}
              </div>
            </div>
          {% endfor %}
          <div class="legend mt-2">ç‚¹å‡»å®¢æˆ·åç§°æŸ¥çœ‹ä¸ªæ€§åŒ–åˆ†æè¯¦æƒ…ï¼ŒçŠ¶æ€é€šè¿‡å…³é”®è¯è‡ªåŠ¨è¯†åˆ«</div>
        </div>
      </div>
    </div>
  </div>

  <script>
    const scoreData = {{ score_data | tojson }};
    const emotionData = {{ emotion_data | tojson }};
    const emotionTrendData = {{ emotion_trend_data | tojson }};
    const keywordData = {{ keyword_data | tojson }};

    new Chart(document.getElementById('scoreChart'), {
      type: 'bar',
      data: {
        labels: scoreData.labels,
        datasets: [{
          label: 'è¯„åˆ†',
          data: scoreData.values,
          backgroundColor: scoreData.values.map(score =>
            score >= 80 ? '#4CAF50' : score >= 60 ? '#FFC107' : '#F44336')
        }]
      },
      options: {
        scales: {
          y: { beginAtZero: true, max: 100 }
        }
      }
    });

    new Chart(document.getElementById('emotionChart'), {
      type: 'pie',
      data: {
        labels: emotionData.labels,
        datasets: [{
          label: 'æƒ…ç»ªå æ¯”',
          data: emotionData.values,
          backgroundColor: ['#4CAF50', '#FFC107', '#F44336']
        }]
      }
    });

    new Chart(document.getElementById('emotionTrendChart'), {
      type: 'line',
      data: {
        labels: emotionTrendData.labels,
        datasets: [
          {
            label: 'ç§¯æ',
            data: emotionTrendData.positive,
            borderColor: '#4CAF50', backgroundColor: 'rgba(76, 175, 80, 0.2)', fill: true
          },
          {
            label: 'ä¸­æ€§',
            data: emotionTrendData.neutral,
            borderColor: '#FFC107', backgroundColor: 'rgba(255, 193, 7, 0.2)', fill: true
          },
          {
            label: 'æ¶ˆæ',
            data: emotionTrendData.negative,
            borderColor: '#F44336', backgroundColor: 'rgba(244, 67, 54, 0.2)', fill: true
          }
        ]
      },
      options: {
        tension: 0.3,
        scales: {
          y: { beginAtZero: true, stepSize: 1 }
        }
      }
    });

    new Chart(document.getElementById('keywordChart'), {
      type: 'bar',
      data: {
        labels: keywordData.labels,
        datasets: [{
          label: 'å…³é”®è¯æ¬¡æ•°',
          data: keywordData.values,
          backgroundColor: '#2196F3'
        }]
      },
      options: {
        indexAxis: 'y',
        scales: {
          x: { beginAtZero: true }
        }
      }
    });
  </script>
</div>
{% endblock %}
